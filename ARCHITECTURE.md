# Multiplayer World - 시스템 구조도

## 🏗️ 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         GitHub Pages                             │
│                  (정적 파일 호스팅만 담당)                        │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  index.html  │  │  client.js   │  │ networking.js│          │
│  │  config.js   │  │game-host.js  │  │game-client.js│          │
│  │    ui.js     │  │   (etc...)   │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS로 다운로드
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       사용자 브라우저                             │
└─────────────────────────────────────────────────────────────────┘


## 🎮 게임 세션 구조 (런타임)

┌──────────────────────────────────────────────────────────────────────┐
│                          PeerJS Cloud Server                          │
│                     (시그널링만 담당 - 무료 서비스)                    │
│                                                                        │
│  역할: Peer 간 초기 연결 중개                                         │
│  - Peer ID 생성 및 관리                                               │
│  - WebRTC 연결을 위한 ICE candidate 교환                              │
│  - 연결 성립 후에는 관여하지 않음                                      │
└────────────┬─────────────────────────────────────┬──────────────────┘
             │                                     │
             │ 초기 시그널링                        │ 초기 시그널링
             │                                     │
             ▼                                     ▼
┌─────────────────────────┐              ┌─────────────────────────┐
│   HOST (호스트)          │              │  CLIENT 1 (플레이어 1)   │
│  Peer ID: abc123xyz     │◄─────────────┤  Peer ID: def456uvw     │
│                         │  WebRTC P2P  │                         │
│  ┌──────────────────┐   │              │  ┌──────────────────┐   │
│  │  Game Simulation │   │              │  │   Rendering      │   │
│  │  (Physics)       │   │              │  │   (Display)      │   │
│  │                  │   │              │  │                  │   │
│  │  - 플레이어 위치  │   │              │  │  - 게임 상태 수신 │   │
│  │  - 중력 계산     │   │  Game State  │  │  - 화면 렌더링    │   │
│  │  - 충돌 감지     │───┼─────────────►│  │                  │   │
│  │  - 월드 경계     │   │              │  │                  │   │
│  └──────────────────┘   │              │  └──────────────────┘   │
│           ▲             │              │           │             │
│           │             │              │           │             │
│        Input            │              │        Input            │
│  (자신의 키보드)          │  ◄───────────┤  (키보드 → 호스트)      │
│                         │   Player     │                         │
└─────────────────────────┘   Input      └─────────────────────────┘
             │                                     ▲
             │                                     │
             │ WebRTC P2P                          │ WebRTC P2P
             │                                     │
             ▼                                     │
┌─────────────────────────┐              ┌─────────────────────────┐
│  CLIENT 2 (플레이어 2)   │              │  CLIENT 3 (플레이어 3)   │
│  Peer ID: ghi789rst     │              │  Peer ID: jkl012mno     │
│                         │              │                         │
│  ┌──────────────────┐   │              │  ┌──────────────────┐   │
│  │   Rendering      │   │              │  │   Rendering      │   │
│  │   (Display)      │   │              │  │   (Display)      │   │
│  └──────────────────┘   │              │  └──────────────────┘   │
└─────────────────────────┘              └─────────────────────────┘


## 📡 데이터 흐름

### 1. 게임 시작 흐름
```
HOST                          PeerJS Server                    CLIENT
  │                                 │                             │
  │ 1. 브라우저 접속                 │                             │
  │────────────────────────────────►│                             │
  │                                 │                             │
  │ 2. Peer ID 요청                 │                             │
  │────────────────────────────────►│                             │
  │                                 │                             │
  │ 3. Peer ID 발급 (abc123xyz)     │                             │
  │◄────────────────────────────────│                             │
  │                                 │                             │
  │ 4. "Host Game" 클릭             │                             │
  │    → Peer ID 화면에 표시         │                             │
  │                                 │                             │
  │ 5. Peer ID를 친구에게 공유       │                             │
  │    (카톡, 디스코드 등)           │                             │
  │                                 │                             │
  │                                 │  6. 브라우저 접속            │
  │                                 │◄────────────────────────────│
  │                                 │                             │
  │                                 │  7. Peer ID 요청            │
  │                                 │◄────────────────────────────│
  │                                 │                             │
  │                                 │  8. Peer ID 발급 (def456)   │
  │                                 │────────────────────────────►│
  │                                 │                             │
  │                                 │  9. Host Peer ID 입력       │
  │                                 │     (abc123xyz)             │
  │                                 │                             │
  │            10. WebRTC 시그널링 교환 (ICE candidates)           │
  │◄─────────────────────────────────────────────────────────────►│
  │                                 │                             │
  │            11. 직접 P2P 연결 성립                              │
  │◄══════════════════════════════════════════════════════════════►│
  │                                 │                             │
```

### 2. 게임 플레이 중 데이터 흐름
```
┌─────────────────────────────────────────────────────────────────┐
│                         30 FPS 루프                              │
└─────────────────────────────────────────────────────────────────┘

HOST                                                          CLIENT
  │                                                              │
  │ 1. 모든 플레이어 입력 수집                                    │
  │    ├─ HOST 자신의 키보드 입력                                │
  │    └─ CLIENT들이 보낸 입력 ◄─────────────────────────────────│
  │                                        (W/A/S/D/Space/카메라) │
  │                                                              │
  │ 2. 게임 로직 계산 (33ms마다)                                 │
  │    ├─ 모든 플레이어 이동 계산                                │
  │    ├─ 중력 적용                                              │
  │    ├─ 점프 처리                                              │
  │    ├─ 지면 충돌                                              │
  │    ├─ 월드 경계 체크                                         │
  │    └─ 플레이어 회전 업데이트                                 │
  │                                                              │
  │ 3. 게임 상태 브로드캐스트                                     │
  │    {                                                         │
  │      players: [                                              │
  │        { id, position, rotation, color },                    │
  │        { id, position, rotation, color },                    │
  │        ...                                                   │
  │      ]                                                       │
  │    }                                                         │
  │                                                              │
  │ 4. 모든 클라이언트에게 전송 ──────────────────────────────────►│
  │                                                              │
  │                                                              │ 5. 상태 수신
  │                                                              │
  │                                                              │ 6. 화면 렌더링
  │                                                              │    ├─ 3D 메시 위치 업데이트
  │                                                              │    ├─ 카메라 추적
  │                                                              │    └─ Three.js 렌더링
  │                                                              │
  │◄─────────────────────────────────────────────────────────────│ 7. 입력 전송
                                (다시 1번으로)                        (키보드 상태)
```


## 🔧 파일별 역할

```
┌─────────────────────────────────────────────────────────────────┐
│                         클라이언트 측                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  📄 index.html                                                   │
│  └─ HTML 구조, UI 레이아웃, 메뉴 화면                             │
│                                                                  │
│  📄 config.js                                                    │
│  └─ 게임 설정 (카메라, 물리, 조작키 등)                           │
│                                                                  │
│  📄 ui.js                                                        │
│  └─ UI 관리 (플레이어 리스트, FPS, 연결 상태)                     │
│                                                                  │
│  📄 networking.js                                                │
│  └─ WebRTC 연결 관리                                             │
│      ├─ PeerJS 초기화                                            │
│      ├─ 방 생성 (Peer ID 반환)                                   │
│      ├─ 방 참가 (Peer ID로 연결)                                 │
│      ├─ 데이터 송수신                                            │
│      └─ 연결 상태 관리                                           │
│                                                                  │
│  📄 game-host.js                                                 │
│  └─ 호스트 전용 게임 로직                                         │
│      ├─ 게임 시뮬레이션 (30 FPS)                                 │
│      ├─ 물리 계산 (이동, 중력, 충돌)                              │
│      ├─ 모든 플레이어 입력 처리                                   │
│      └─ 게임 상태 브로드캐스트                                    │
│                                                                  │
│  📄 game-client.js                                               │
│  └─ 클라이언트 전용 게임 로직                                     │
│      ├─ 입력을 호스트로 전송                                      │
│      ├─ 게임 상태 수신                                           │
│      └─ 상태 업데이트 콜백                                        │
│                                                                  │
│  📄 client.js                                                    │
│  └─ 메인 게임 애플리케이션                                        │
│      ├─ Three.js 씬 초기화                                       │
│      ├─ 플레이어 메시 생성/관리                                   │
│      ├─ 카메라 컨트롤                                            │
│      ├─ 렌더링 루프                                              │
│      ├─ 호스트/클라이언트 모드 전환                               │
│      └─ UI 이벤트 처리                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```


## 🔐 현재 보안 상태

```
┌─────────────────────────────────────────────────────────────────┐
│                         ⚠️ 보안 없음                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ❌ 인증 없음                                                     │
│     └─ Peer ID만 알면 누구나 접속 가능                            │
│                                                                  │
│  ❌ 권한 관리 없음                                                │
│     └─ 호스트가 플레이어를 거부할 수 없음                          │
│                                                                  │
│  ❌ 암호화 없음 (데이터 레벨)                                      │
│     └─ WebRTC는 자동 암호화되지만 게임 데이터는 평문              │
│                                                                  │
│  ❌ 입력 검증 없음                                                │
│     └─ 악의적인 입력값 전송 가능                                  │
│                                                                  │
│  ❌ 플레이어 한도 없음                                            │
│     └─ 무제한 접속 가능 (성능 문제 발생 가능)                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```


## 💡 개선 가능한 부분

### 1. 호스트 승인 시스템
```
CLIENT 접속 시도
    │
    ▼
HOST에게 알림
    │
    ├─► [수락] ──► 게임 참가
    │
    └─► [거부] ──► 연결 종료
```

### 2. 방 비밀번호
```
HOST: Peer ID + 비밀번호 생성
    │
    ▼
CLIENT: Peer ID + 비밀번호 입력
    │
    ├─► 비밀번호 일치 ──► 연결 허용
    │
    └─► 비밀번호 불일치 ──► 연결 거부
```

### 3. 최대 플레이어 제한
```
현재: 무제한
개선: 호스트가 설정 (예: 최대 8명)
```


## 📊 성능 특성

### 데이터 사용량 (예상)
```
게임 상태 패킷 크기: ~200-500 bytes
전송 빈도: 30 FPS = 30번/초

호스트 (4명 게임 기준):
  ├─ 업로드: ~50 KB/s (모든 클라이언트에게)
  └─ 다운로드: ~10 KB/s (모든 입력 수신)

클라이언트:
  ├─ 업로드: ~2 KB/s (입력만 전송)
  └─ 다운로드: ~15 KB/s (게임 상태 수신)
```

### 지연시간
```
로컬 네트워크: 1-10ms
같은 도시: 20-50ms
같은 국가: 50-100ms
다른 국가: 100-300ms
```

### 제한사항
```
- 호스트가 떨어지면 게임 종료
- 호스트의 CPU/네트워크에 의존
- 많은 플레이어 시 호스트 부하 증가
- NAT 통과 실패 시 연결 불가 (일부 환경)
```
